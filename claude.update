#!/bin/bash
#shellcheck disable=SC2015  # A && B || C pattern is intentional
#shellcheck disable=SC2012  # ls used safely for version sorting
# Update Claude CLI - handles system installations properly
set -euo pipefail
shopt -s inherit_errexit shift_verbose extglob nullglob

### VERSION
declare -r VERSION=1.4.0
###
#shellcheck disable=SC2155
declare -r SCRIPT_PATH=$(realpath -- "$0")
declare -r SCRIPT_NAME=${SCRIPT_PATH##*/}

# Color output
if [[ -t 2 ]]; then
  declare -r RED=$'\033[0;31m' YELLOW=$'\033[1;33m' CYAN=$'\033[0;36m' NC=$'\033[0m'
else
  declare -r RED='' YELLOW='' CYAN='' NC=''
fi

info() { >&2 echo "$SCRIPT_NAME: ${CYAN}◉${NC} $*"; }
warn() { >&2 echo "$SCRIPT_NAME: ${YELLOW}▲${NC} $*"; }
error() { >&2 echo "$SCRIPT_NAME: ${RED}✗${NC} $*"; }
die() { (($# < 2)) || error "${@:2}"; exit "${1:-0}"; }

# Compare versions: returns 0 if $1 > $2
version_gt() {
  [[ "$1" != "$2" ]] && [[ "$1" == "$(printf '%s\n%s' "$1" "$2" | sort -V | tail -1)" ]]
}

declare -r SYSTEM_CLAUDE=${SYSTEM_CLAUDE:-/usr/local/bin/claude}
declare -r NATIVE_DIR="$HOME"/.local/share/claude
declare -r NATIVE_BIN="$HOME"/.local/bin/claude

show_help() {
  cat <<EOF
$SCRIPT_NAME $VERSION - Update Claude CLI (handles system installations)

USAGE
    $SCRIPT_NAME [OPTIONS]

OPTIONS
    -h, --help      Show this help
    -V, --version   Show version

BEHAVIOR
    For system installations (/usr/local/bin/claude):
      1. Runs 'claude update' to download latest version
      2. Copies new binary to /usr/local/bin/claude (requires sudo)
      3. Cleans up native installation files
      4. Creates ~/.local/bin/claude symlink if needed (bug #17289 workaround)
      5. Ensures installMethod=system in ~/.claude.json

    For native installations:
      Runs 'claude update' normally
EOF
}

main() {

  # Parse arguments
  while (($#)); do
    case $1 in
      -h|--help) show_help; return 0 ;;
      -V|--version) echo "$SCRIPT_NAME $VERSION"; return 0 ;;
      *) break ;;
    esac
    shift
  done

  # Determine installation type
  if [[ ! -x "$SYSTEM_CLAUDE" ]]; then
    # Native installation - just run update normally
    claude update "$@"
    return $?
  fi

  info "System installation detected at ${SYSTEM_CLAUDE@Q}"

  # Get current version
  local -- current_version
  current_version=$("$SYSTEM_CLAUDE" --version 2>/dev/null | head -1) || current_version="unknown"
  info "Current version: $current_version"

  # Fix config BEFORE update if needed (prevents "Failed to check for updates" error)
  if [[ -f "$HOME"/.claude.json ]] && command -v jq &>/dev/null; then
    local -- current_method
    current_method=$(jq -r '.installMethod // "unknown"' "$HOME/.claude.json")
    if [[ "$current_method" != system ]]; then
      info 'Setting installMethod=system before update'
      local -- tmp_file
      tmp_file=$(mktemp) || die 1 'Failed to create temp file'
      jq '.installMethod = "system"' "$HOME"/.claude.json > "$tmp_file"
      mv "$tmp_file" "$HOME"/.claude.json
    fi
  fi

  # Run update (downloads to native location)
  info 'Downloading latest version...'
  claude update "$@" || die 1 'Update failed'

  # Find the new version
  if [[ -d "$NATIVE_DIR"/versions ]] && [[ -n "$(ls -A "$NATIVE_DIR"/versions 2>/dev/null)" ]]; then
    local -- new_version new_binary
    new_version=$(ls -1 "$NATIVE_DIR"/versions | sort -V | tail -1)
    new_binary="$NATIVE_DIR"/versions/"$new_version"

    if [[ -x "$new_binary" ]]; then
      info "New version downloaded: $new_version"

      # Extract version number from current (e.g., "2.1.3 (Claude Code)" -> "2.1.3")
      local -- current_ver_num
      current_ver_num=${current_version%% *}

      # Prevent downgrades
      if ! version_gt "$new_version" "$current_ver_num"; then
        warn "Downloaded version $new_version is not newer than installed $current_ver_num"
        info "Skipping installation. Cleaning up..."
        rm -rf "$NATIVE_DIR" || :
        rm -f "$NATIVE_BIN" || :
        info "Already at latest version: $current_version"
        return 0
      fi

      # Copy to system location (needs sudo)
      info "Installing to $SYSTEM_CLAUDE (requires sudo)..."
      sudo cp "$new_binary" "$SYSTEM_CLAUDE" || die 1 "Failed to copy to $SYSTEM_CLAUDE"
      sudo chmod 755 "$SYSTEM_CLAUDE" || die 1 "Failed to set permissions"
      sudo chown root:root "$SYSTEM_CLAUDE" || die 1 "Failed to set ownership"

      info "Cleaning up native installation..."
      rm -rf "$NATIVE_DIR" || :
      rm -f "$NATIVE_BIN" || :

      # Workaround for Claude Code detection bug (#17289):
      # Claude ignores installMethod=system when ~/.local/bin/ exists.
      # Create symlink to satisfy the detection check.
      local -- local_bin="$HOME"/.local/bin
      if [[ -d "$local_bin" && ! -e "$local_bin/claude" ]]; then
        info "Creating symlink workaround for detection bug..."
        ln -sf "$SYSTEM_CLAUDE" "$local_bin/claude"
        info "Symlink: $local_bin/claude -> $SYSTEM_CLAUDE"
      fi

      # Restore config to system (claude update may have changed it to native)
      if [[ -f "$HOME"/.claude.json ]] && command -v jq &>/dev/null; then
        local -- post_method
        post_method=$(jq -r '.installMethod // "unknown"' "$HOME/.claude.json")
        if [[ "$post_method" != system ]]; then
          info 'Restoring installMethod=system after update'
          local -- tmp_file2
          tmp_file2=$(mktemp) || die 1 'Failed to create temp file'
          jq '.installMethod = "system"' "$HOME"/.claude.json > "$tmp_file2"
          mv "$tmp_file2" "$HOME"/.claude.json
        fi
      fi

      local -- new_installed
      new_installed=$("$SYSTEM_CLAUDE" --version 2>/dev/null | head -1)
      info "Successfully updated: $new_installed"
    else
      error "New binary not found at ${new_binary@Q}"
      exit 1
    fi
  else
    info 'Already at latest version'
  fi
}

main "$@"
#fin
