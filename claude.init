#!/usr/bin/env bash
#shellcheck disable=SC2015
# claude.init - Initialize project for Claude Code
# Usage: claude.init [OPTIONS] [project_dir]
set -euo pipefail
shopt -s inherit_errexit shift_verbose extglob nullglob

declare -r VERSION=1.1.0
#shellcheck disable=SC2155
declare -r SCRIPT_PATH=$(realpath -- "$0")
declare -r SCRIPT_NAME=${SCRIPT_PATH##*/}
declare -r SCRIPT_DIR=${SCRIPT_PATH%/*}

declare -- PROJECT_DIR="${PROJECT_DIR:-}"

declare -- CLAUDE_ETC_MD=/etc/claude-code/CLAUDE.md
declare -- CLAUDE_ENT_MD=${CLAUDE_ENT_MD:-"$SCRIPT_DIR"/CLAUDE.enterprise.md}
declare -- CLAUDE_PROJECT_MD=${CLAUDE_PROJECT_MD:-"$SCRIPT_DIR"/CLAUDE.project.md}

declare -- BCS_TIER_FILE=${BCS_TIER_FILE:-/ai/scripts/Okusi/bash-coding-standard/BASH-CODING-STANDARD.md}

declare -- CLAUDE_X_AGENT=${CLAUDE_X_AGENT:-leet}

declare -- CLAUDE_UPDATE=${CLAUDE_UPDATE:-0}

declare -i CLOBBER=${CLOBBER:-0}

declare -r CLAUDE_GROUP=${CLAUDE_GROUP:-claude-users}

# Colors
if [[ -t 1 && -t 2 ]]; then
  declare -r RED=$'\033[0;31m' GREEN=$'\033[0;32m' YELLOW=$'\033[1;33m' CYAN=$'\033[0;36m' NC=$'\033[0m'
else
  declare -r RED='' GREEN='' YELLOW='' CYAN='' NC=''
fi

version() { echo "$SCRIPT_NAME $VERSION"; }

show_help() {
  cat <<HELP
$SCRIPT_NAME $VERSION - Initialize project for Claude Code

USAGE
    $SCRIPT_NAME [OPTIONS] [project_dir]

OPTIONS
    -h, --help          Show this help
    -V, --version       Show version
    -v, --verbose       Increase verbosity
    -q, --quiet         Suppress messages
    -u, --claude-update Run 'claude update' first
    -C, --clobber       Overwrite existing files without prompting

DESCRIPTION
    Initializes a project directory with Claude Code configuration:
    - Creates/updates enterprise policy ($CLAUDE_ETC_MD)
    - Creates project CLAUDE.md from template
    - Creates BASH-CODING-STANDARD.md symlink
    - Updates .gitignore with Claude-related entries

    Permissions set:
    - Enterprise: 664, root:$CLAUDE_GROUP
    - Project files: 644

ENVIRONMENT
    PROJECT_DIR         Target directory (default: current)
    CLAUDE_X_AGENT      Agent to suggest (default: $CLAUDE_X_AGENT)
    CLAUDE_GROUP        Enterprise group (default: $CLAUDE_GROUP)

HELP
}

declare -i VERBOSE=1

_msg() {
  local -- prefix="$SCRIPT_NAME:" msg
  case ${FUNCNAME[1]} in
    vecho)   : ;;
    info)    prefix+=" ${CYAN}◉${NC}" ;;
    warn)    prefix+=" ${YELLOW}▲${NC}" ;;
    success) prefix+=" ${GREEN}✓${NC}" ;;
    error)   prefix+=" ${RED}✗${NC}" ;;
    *)       ;;
  esac
  for msg in "$@"; do printf '%s %s\n' "$prefix" "$msg"; done
}

vecho() { ((VERBOSE)) || return 0; _msg "$@"; }
info() { ((VERBOSE)) || return 0; >&2 _msg "$@"; }
warn() { ((VERBOSE)) || return 0; >&2 _msg "$@"; }
success() { ((VERBOSE)) || return 0; >&2 _msg "$@" || return 0; }
error() { >&2 _msg "$@"; }
die() { (($# < 2)) || error "${@:2}"; exit "${1:-0}"; }
yn() {
  local -- REPLY
  >&2 read -r -n 1 -p "$(2>&1 warn "${1:-'Continue?'}") y/n "
  >&2 echo
  [[ ${REPLY,,} == y ]]
}

# --------------------------------------------------------------------------------
main() {
  local -- REPLY
  while (($#)); do
    case $1 in
      -v|--verbose)  VERBOSE+=1 ;;
      -q|--quiet)    VERBOSE=0 ;;
      -u|--claude-update)
                     CLAUDE_UPDATE=1 ;;
      -C|--clobber)  CLOBBER=1 ;;
      -V|--version)  version; return 0 ;;
      -h|--help)     show_help; return 0 ;;
      -[uvVhC]*) #shellcheck disable=SC2046
                     set -- '' $(printf -- '-%c ' $(grep -o . <<<"${1:1}")) "${@:2}" ;;
      -*)            die 22 "Invalid option ${1@Q} Help: $SCRIPT_NAME -h";;
      *)             [[ -z $PROJECT_DIR ]] || die 2 "Too many arguments ${1@Q} Help: $SCRIPT_NAME -h"
                     PROJECT_DIR=$1
       ;;
    esac
    shift
  done
  [[ -n "$PROJECT_DIR" ]] || PROJECT_DIR=$PWD

  # Update claude
  if ((CLAUDE_UPDATE)); then
    claude update || die $?
  fi

  local -i REINIT=0

  # Get into/create the project directory
  if [[ ! -d "$PROJECT_DIR" ]]; then
    echo "${PROJECT_DIR@Q} does not exist."
    read -r -n1 -p "Create ${PROJECT_DIR@Q}? y/n "
    [[ $REPLY == 'y' ]] || die 1
    echo
    REINIT=1
    mkdir -p "$PROJECT_DIR" || die 1
    chmod 755 "$PROJECT_DIR"
  fi
  cd "$PROJECT_DIR" || die 1

  # Bash coding standard symlink
  if [[ ! -L "$PROJECT_DIR"/BASH-CODING-STANDARD.md ]] || ((CLOBBER)); then
    ln -fs "$BCS_TIER_FILE" "$PROJECT_DIR"/BASH-CODING-STANDARD.md
    REINIT=1
  fi

  # Init enterprise CLAUDE to /etc/claude-code/
  if [[ ! -f $CLAUDE_ETC_MD ]]; then
    sudo cp "$CLAUDE_ENT_MD" "$CLAUDE_ETC_MD"
    REINIT=1
  fi
  if ! sudo diff -q "$CLAUDE_ENT_MD" "$CLAUDE_ETC_MD" >/dev/null 2>&1; then
    if ((CLOBBER)); then
      sudo cp "$CLAUDE_ENT_MD" "$CLAUDE_ETC_MD"
      REINIT=1
    else
      warn "Enterprise CLAUDE.md differs from template"
      if yn "Update ${CLAUDE_ETC_MD@Q}?"; then
        sudo cp "$CLAUDE_ENT_MD" "$CLAUDE_ETC_MD"
        REINIT=1
      fi
      >&2 echo
    fi
  fi
  sudo chown root:"$CLAUDE_GROUP" "$CLAUDE_ETC_MD"
  sudo chmod 664 "$CLAUDE_ETC_MD"
  sudo chmod 2775 "${CLAUDE_ETC_MD%/*}"
  
  # Project CLAUDE.md
  if [[ -f "$PROJECT_DIR"/CLAUDE.md ]]; then
    if ((CLOBBER)); then
      cp "$CLAUDE_PROJECT_MD" "$PROJECT_DIR"/CLAUDE.md
      chmod 644 "$PROJECT_DIR"/CLAUDE.md
      REINIT=1
    else
      warn "CLAUDE.md already exists in ${PROJECT_DIR@Q}."
      if yn 'Append canonical info?'; then
        { echo; echo '---'; cat -s "$CLAUDE_PROJECT_MD"; } >> "$PROJECT_DIR"/CLAUDE.md
        chmod 644 "$PROJECT_DIR"/CLAUDE.md
        REINIT=1
      fi
    fi
  else
    if ((CLOBBER)); then
      cp "$CLAUDE_PROJECT_MD" "$PROJECT_DIR"/CLAUDE.md
      chmod 644 "$PROJECT_DIR"/CLAUDE.md
      REINIT=1
    else
      read -r -n 1 -p "Init claude in ${PROJECT_DIR@Q}? y/n "
      if [[ ${REPLY,,} == y ]]; then
        cp "$CLAUDE_PROJECT_MD" "$PROJECT_DIR"/CLAUDE.md
        chmod 644 "$PROJECT_DIR"/CLAUDE.md
        REINIT=1
      fi
    fi
  fi
  >&2 echo
  
  # Process .gitignore
  if [[ ! -f "$PROJECT_DIR"/.gitignore ]]; then
    cat -s "$SCRIPT_DIR"/.gitignore > "$PROJECT_DIR"/.gitignore
    chmod 644 "$PROJECT_DIR"/.gitignore
  fi
  #shellcheck disable=SC2094
  local -- ignore
  for ignore in CLAUDE.md .claude 'AUDIT-\*.md' .gudang BASH-CODING-STANDARD.md; do
    if ! grep -q -m1 ^"$ignore"$ "$PROJECT_DIR"/.gitignore; then
      echo -e "\n# Ignore from claude.init: ${ignore@Q}" >>"$PROJECT_DIR"/.gitignore
      echo "$ignore" >>"$PROJECT_DIR"/.gitignore
      REINIT=1
    fi
  done
  unset ignore

  success "Project ${PROJECT_DIR@Q} $( ((REINIT==0)) && echo 'verified' || echo 'initialized' )"
  info "Suggested: agents/$CLAUDE_X_AGENT --model opus"
}

main "$@"
#fin
