#!/usr/bin/env bash
#shellcheck disable=SC2015
# Create canonical CLAUDE.md in current directory
set -euo pipefail
shopt -s inherit_errexit shift_verbose extglob nullglob

declare -r VERSION=1.0.7
#shellcheck disable=SC2155
declare -r SCRIPT_PATH=$(realpath -- "$0")
declare -r SCRIPT_NAME=${SCRIPT_PATH##*/}
declare -r SCRIPT_DIR=${SCRIPT_PATH%/*}

declare -- PROJECT_DIR="${PROJECT_DIR:-}"

declare -- CLAUDE_ETC_MD=/etc/claude-code/CLAUDE.md
declare -- CLAUDE_ENT_MD=${CLAUDE_ENT_MD:-"$SCRIPT_DIR"/CLAUDE.enterprise.md}
declare -- CLAUDE_PROJECT_MD=${CLAUDE_PROJECT_MD:-"$SCRIPT_DIR"/CLAUDE.project.md}

declare -- BCS_TIER_FILE=${BCS_TIER_FILE:-/ai/scripts/Okusi/bash-coding-standard/BASH-CODING-STANDARD.md}

declare -- CLAUDE_X_AGENT=${CLAUDE_X_AGENT:-leet}

declare -- CLAUDE_UPDATE=${CLAUDE_UPDATE:-0}

declare -r CLAUDE_GROUP=${CLAUDE_GROUP:-claude-users}

# Colors
if [[ -t 1 && -t 2 ]]; then
  declare -r RED=$'\033[0;31m' GREEN=$'\033[0;32m' YELLOW=$'\033[1;33m' CYAN=$'\033[0;36m' NC=$'\033[0m'
else
  declare -r RED='' GREEN='' YELLOW='' CYAN='' NC=''
fi

version() { echo "$SCRIPT_NAME $VERSION"; }

show_help() {
  local -- project_dir=${PROJECT_DIR:-"$PWD"}
  cat <<HELP
$(version) - Standard Project Repo Initialization

Creates canonical claude project directory, adds/updates files:

  $CLAUDE_ETC_MD
  $project_dir/CLAUDE.md
  $project_dir/BASH-CODING-STANDARD.md
  $project_dir/.gitignore

Usage: $SCRIPT_NAME [-u|--claude-update] [project_dir]

If omitted, project_dir defaults to current directory.

Configurable Envvars showing current defaults:

  PROJECT_DIR=$project_dir
  CLAUDE_ETC_MD=$CLAUDE_ETC_MD
  CLAUDE_PROJECT_MD=$CLAUDE_PROJECT_MD
  BCS_TIER_FILE=$BCS_TIER_FILE
  CLAUDE_UPDATE=$CLAUDE_UPDATE
  CLAUDE_X_AGENT=$CLAUDE_X_AGENT
  CLAUDE_GROUP=$CLAUDE_GROUP

Available Agents:

$(find "$SCRIPT_DIR"/agents/ -maxdepth 2 -type l -executable -exec basename {} \; 2>/dev/null | sort | xargs -n1 echo '   ')

HELP
}

declare -i VERBOSE=1

_msg() {
  local -- prefix="$SCRIPT_NAME:" msg
  case ${FUNCNAME[1]} in
    vecho)   : ;;
    info)    prefix+=" ${CYAN}◉${NC}" ;;
    warn)    prefix+=" ${YELLOW}▲${NC}" ;;
    success) prefix+=" ${GREEN}✓${NC}" ;;
    error)   prefix+=" ${RED}✗${NC}" ;;
    *)       ;;
  esac
  for msg in "$@"; do printf '%s %s\n' "$prefix" "$msg"; done
}

vecho() { ((VERBOSE)) || return 0; _msg "$@"; }
info() { ((VERBOSE)) || return 0; >&2 _msg "$@"; }
warn() { ((VERBOSE)) || return 0; >&2 _msg "$@"; }
success() { ((VERBOSE)) || return 0; >&2 _msg "$@" || return 0; }
error() { >&2 _msg "$@"; }
die() { (($# < 2)) || error "${@:2}"; exit "${1:-0}"; }
yn() {
  local -- REPLY
  >&2 read -r -n 1 -p "$(2>&1 warn "${1:-'Continue?'}") y/n "
  >&2 echo
  [[ ${REPLY,,} == y ]]
}

# --------------------------------------------------------------------------------
main() {
  local -- REPLY
  while (($#)); do
    case $1 in
      -v|--verbose)  VERBOSE+=1 ;;
      -q|--quiet)    VERBOSE=0 ;;
      -u|--claude-update)
                     CLAUDE_UPDATE=1 ;;
      -V|--version)  version; return 0 ;;
      -h|--help)     show_help; return 0 ;;
      -[uvVh]*) #shellcheck disable=SC2046
                     set -- '' $(printf -- '-%c ' $(grep -o . <<<"${1:1}")) "${@:2}" ;;
      -*)            die 22 "Invalid option ${1@Q} Help: $SCRIPT_NAME -h";;
      *)             [[ -z $PROJECT_DIR ]] || die 2 "Too many arguments ${1@Q} Help: $SCRIPT_NAME -h"
                     PROJECT_DIR=$1
       ;;
    esac
    shift
  done
  [[ -n "$PROJECT_DIR" ]] || PROJECT_DIR=$PWD

  # Update claude
  if ((CLAUDE_UPDATE)); then
    claude update || die $?
  fi

  local -i REINIT=0

  # Get into/create the project directory
  if [[ ! -d "$PROJECT_DIR" ]]; then
    echo "${PROJECT_DIR@Q} does not exist."
    read -r -n1 -p "Create ${PROJECT_DIR@Q}? y/n "
    [[ $REPLY == 'y' ]] || die 1
    echo
    REINIT=1
    mkdir -p "$PROJECT_DIR" || die 1
  fi
  cd "$PROJECT_DIR" || die 1

  # Bash coding standard
  if [[ ! -f "$PROJECT_DIR"/BASH-CODING-STANDARD.md ]]; then
    if [[ ! -L "$PROJECT_DIR"/BASH-CODING-STANDARD.md ]]; then
      ln -fs "$BCS_TIER_FILE" "$PROJECT_DIR"/BASH-CODING-STANDARD.md
      REINIT=1
    fi
  fi

  # Init enterprise CLAUDE to /etc/claude-code/
  if [[ ! -f $CLAUDE_ETC_MD ]]; then
    sudo cp "$CLAUDE_ENT_MD" "$CLAUDE_ETC_MD"
    REINIT=1
  fi
  if ! sudo diff -q "$CLAUDE_ENT_MD" "$CLAUDE_ETC_MD" >/dev/null 2>&1; then
    warn "WARNING: ${CLAUDE_ETC_MD@Q} differs from template ${CLAUDE_ENT_MD@Q}\n"
    if yn "Update ${CLAUDE_ETC_MD@Q}?"; then
      sudo cp "$CLAUDE_ENT_MD" "$CLAUDE_ETC_MD"
      REINIT=1
    fi
    >&2 echo
  fi
  sudo chown root:"$CLAUDE_GROUP" "$CLAUDE_ETC_MD"
  sudo chmod 664 "$CLAUDE_ETC_MD"
  sudo chmod 2775 "${CLAUDE_ETC_MD%/*}"
  
  # Check if project CLAUDE.md exists
  if [[ -f "$PROJECT_DIR"/CLAUDE.md ]]; then
    warn "CLAUDE.md already exists in ${PROJECT_DIR@Q}."
    if yn 'Append canonical info?'; then
      { echo
        echo '---'
        cat -s "$CLAUDE_PROJECT_MD"
      } >> "$PROJECT_DIR"/CLAUDE.md
      REINIT=1
    fi
  else
    read -r -n 1 -p "Init claude in ${PROJECT_DIR@Q}? y/n "
    if [[ ${REPLY,,} == y ]]; then
      cp -p "$CLAUDE_PROJECT_MD" "$PROJECT_DIR"/CLAUDE.md
    fi
  fi
  >&2 echo
  
  # Process .gitignore
  [[ -f "$PROJECT_DIR"/.gitignore ]] \
      || cat -s "$SCRIPT_DIR"/.gitignore > "$PROJECT_DIR"/.gitignore
  #shellcheck disable=SC2094
  local -- ignore
  for ignore in CLAUDE.md .claude 'AUDIT-\*.md' .gudang BASH-CODING-STANDARD.md; do
    if ! grep -q -m1 ^"$ignore"$ "$PROJECT_DIR"/.gitignore; then
      echo -e "\n# Ignore from claude.init: ${ignore@Q}" >>"$PROJECT_DIR"/.gitignore
      echo "$ignore" >>"$PROJECT_DIR"/.gitignore
      REINIT=1
    fi
  done
  unset ignore

  echo "Project directory ${PROJECT_DIR@Q} has been $( ((REINIT==0)) || echo 're-' )initialized"

  declare -a args=("$CLAUDE_X_AGENT" --model opus '[--continue][--new] [...]')
  echo "Ready to execute agent: ${args[*]}"
}

main "$@"
#fin
