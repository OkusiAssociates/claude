#!/usr/bin/env bash
#shellcheck disable=SC2034,SC2155
# Launch claude.x with sarki agent
set -euo pipefail
shopt -s inherit_errexit extglob nullglob

declare -r VERSION=1.0.0
declare -r SCRIPT_NAME=${0##*/}  # No realpath()

declare -r LOGFILE=/var/log/agents/"$SCRIPT_NAME".log

declare -- lockname=${PWD//\//-}
lockname=${lockname/-/}

declare -a SHLOCK=()

declare -ix CLAUDE_CODE_MAX_OUTPUT_TOKENS=32000

show_help(){
  cat <<HELP
$SCRIPT_NAME $VERSION - Sarcastic Jakarta assistant for claude code

Sarki: A deeply unhelpful, sarcastic Jakarta cewek assistant.

Usage: $SCRIPT_NAME [-n|--new] [-c|--continue] [-s|--steal] [-M|--maxtokens] [...]
       $SCRIPT_NAME --setup
       $SCRIPT_NAME --show-log

  --setup      Setup log file at ${LOGFILE@Q} (requires sudo)
  --show-log   Display the log file

  [...]        All other arguments and options are sent to claude.x
HELP
}

while(($#)); do
  case $1 in
    -V|--version)
      echo "$SCRIPT_NAME $VERSION"
      claude.x --version
      exit 0
      ;;
    -h|--help)
      show_help
      exit 0
      ;;
    -S|--setup)
      # Setup log directory and file with proper permissions
      if ((EUID)); then
        >&2 echo "$SCRIPT_NAME: error: --setup requires root privileges. Run with sudo."
        exit 1
      fi
      [[ -d /var/log/agents ]] || mkdir -p /var/log/agents
      chmod 755 /var/log/agents
      chown root:adm /var/log/agents
      touch "$LOGFILE"
      chmod 666 "$LOGFILE"
      chown root:adm "$LOGFILE"
      echo "$SCRIPT_NAME: Log directory /var/log/agents (755, root:adm)"
      echo "$SCRIPT_NAME: Log file created ${LOGFILE@Q} (666, root:adm)"
      exit 0
      ;;

    -L|--show-log)
      cat "$LOGFILE"
      exit 0
      ;;

    -s|--steal)
      SHLOCK+=(--steal)
      ;;

    -M|--maxtokens)
      CLAUDE_CODE_MAX_OUTPUT_TOKENS=64000
      ;;

    -[VhSLsM]*) #shellcheck disable=SC2046
      set -- '' $(printf -- '-%c ' $(grep -o . <<<"${1:1}")) "${@:2}"
      ;;

    *) break
      ;;
  esac
  shift
done

# Run from home directory (sarki doesn't need project context)
cd "$HOME"

SHLOCK+=(
  "$lockname"-"$SCRIPT_NAME"
  --
  claude.x
  -T "$SCRIPT_NAME"
  "$@"
)

# Log invocation if log file is writable
# Note: Run 'sudo sarki --setup' to create and configure the log file
if [[ -w "$LOGFILE" ]]; then
  echo "$(date +'%F %T') ${SUDO_USER:-"$USER"} $lockname $*" >>"$LOGFILE"
fi

shlock "${SHLOCK[@]}"
#fin
