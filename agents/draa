#!/bin/bash
#shellcheck disable=SC2034,SC2155
# Launch claude.x with draa agent
set -euo pipefail
shopt -s inherit_errexit extglob nullglob

declare -- VERSION=1.1.0

declare -r DRAA_LOG=/var/log/draa.log

declare -- lockname="${PWD//\//-}"
lockname=${lockname/-/}

declare -a SHLOCK=()

declare -ixr CLAUDE_CODE_MAX_OUTPUT_TOKENS=32000

declare -x VECTORDBS=${VECTORDBS:-/var/lib/vectordbs}

trim() {
  # Process arguments if provided
  if (($#)); then
    local -- v
    if [[ $1 == '-e' ]]; then
      # Process escape sequences when -e flag is used
      shift
      v=$(echo -en "$*")
    else
      v="$*"
    fi
    # Remove leading whitespace first
    v="${v#"${v%%[![:blank:]]*}"}"
    # Then remove trailing whitespace
    echo -n "${v%"${v##*[![:blank:]]}"}"
    return 0
  fi

  # Process stdin if available
  if [[ ! -t 0 ]]; then
    local -- REPLY
    while IFS= read -r REPLY || [[ -n "$REPLY" ]]; do
      # Remove leading whitespace
      REPLY="${REPLY#"${REPLY%%[![:blank:]]*}"}"
      # Remove trailing whitespace
      REPLY="${REPLY%"${REPLY##*[![:blank:]]}"}"
      echo "$REPLY"
    done
  fi
  return 0
}


while(($#)); do
  case $1 in
    -h|--help)
      echo 'Usage: draa [-n|--new] [-c|--continue] [-s|--steal] [-M|--maxtokens] [--setup] ...'
      echo "  --setup    Setup log file at ${DRAA_LOG@Q} (requires sudo)"
      exit 0
      ;;
    -S|--setup)
      # Setup log file with proper permissions
      if ((EUID)); then
        >&2 echo 'draa: error: --setup requires root privileges. Run with sudo.'
        exit 1
      fi
      touch "$DRAA_LOG"
      chmod 664 "$DRAA_LOG"
      chown root:adm "$DRAA_LOG"
      echo "draa: Log file created ${DRAA_LOG@Q} (664, root:adm)"
      exit 0
      ;;
    -l|--log)
      cat "$DRAA_LOG"
      exit
      ;;
    -s|--steal)
      SHLOCK+=(--steal)
      ;;
    -M|--maxtokens)
      CLAUDE_CODE_MAX_OUTPUT_TOKENS=64000
      ;;
    *) break
      ;;
  esac
  shift
done

declare -- SYSTEM_PROMPT=''
declare -- query_role='' short_desc='' long_desc=''
query_role=$(grep '^query_role' "$VECTORDBS"/appliedanthropology/appliedanthropology.cfg | cut -d= -f2 |trim || echo '')
query_role=$(trim -e "$query_role")
short_desc=$(grep '^short_desc' "$VECTORDBS"/appliedanthropology/appliedanthropology.cfg | cut -d= -f2 |trim || echo '')
short_desc=$(trim -e "$short_desc")
long_desc=$(grep '^long_desc' "$VECTORDBS"/appliedanthropology/appliedanthropology.cfg | cut -d= -f2 |trim ||echo '')
long_desc=$(trim -e "$long_desc")

SYSTEM_PROMPT="# Applied Anthropology

## short_desc

$short_desc

## long_desc

$long_desc

## query_role

$query_role

"

SHLOCK+=(
  "$lockname"-draa
  --
  claude.x
  -T draa
  --system-prompt "$SYSTEM_PROMPT"
  "$@"
)

# Log invocation if log file is writable
# Note: Run 'sudo draa --setup' to create and configure the log file
if [[ -w "$DRAA_LOG" ]]; then
  echo "$(date +'%F %T') ${SUDO_USER:-"$USER"} $lockname $*" >>"$DRAA_LOG"
fi

shlock "${SHLOCK[@]}"
#fin
