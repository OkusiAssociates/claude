#!/bin/bash
# Fix permissions on Claude Code directories
#
# Usage: sudo ./claude.fix-permissions [OPTIONS]
#
set -euo pipefail
shopt -s inherit_errexit extglob nullglob

declare -r VERSION=1.3.0
#shellcheck disable=SC2155
declare -r SCRIPT_PATH=$(realpath -- "$0")
#shellcheck disable=SC2034
declare -r SCRIPT_DIR=${SCRIPT_PATH%/*}
declare -r SCRIPT_NAME=${SCRIPT_PATH##*/}

# Configuration
declare -r ENTERPRISE_DIR=/etc/claude-code
declare -r CLAUDE_GROUP=claude-users

# Colors
if [[ -t 2 ]]; then
  declare -r RED=$'\033[0;31m' GREEN=$'\033[0;32m' YELLOW=$'\033[1;33m' CYAN=$'\033[0;36m' NC=$'\033[0m'
else
  declare -r RED='' GREEN='' YELLOW='' CYAN='' NC=''
fi

info()   { echo -e "$SCRIPT_NAME: ${CYAN}◉${NC} $*"; }
status() { echo -e "$SCRIPT_NAME: ${GREEN}✓${NC} $*"; }
warn()   { >&2 echo -e "$SCRIPT_NAME: ${YELLOW}▲${NC} $*"; }
error()  { >&2 echo -e "$SCRIPT_NAME: ${RED}✗${NC} $*"; }
die()    { error "$2"; exit "$1"; }

show_help() {
  cat <<EOF
$SCRIPT_NAME $VERSION - Fix Claude Code directory permissions

USAGE
    sudo $SCRIPT_NAME [OPTIONS]

OPTIONS
    -h, --help          Show this help message
    -V, --version       Show version
    -n, --dry-run       Show what would be done without making changes
    -u, --user USERNAME Fix permissions on user's ~/.claude/ directory

DESCRIPTION
    Resets permissions on Claude Code directories.

    Enterprise ($ENTERPRISE_DIR):
    - Directories: 2775 (rwxrwsr-x) with setgid
    - Files: 664 (rw-rw-r--)
    - Ownership: root:$CLAUDE_GROUP

    User (~/.claude/):
    - Directories: 755 (rwxr-xr-x)
    - Files: 644 (rw-r--r--)
    - Ownership: USER:USER

EXAMPLES
    # Fix enterprise permissions only
    sudo $SCRIPT_NAME

    # Fix permissions for a specific user
    sudo $SCRIPT_NAME --user gary

    # Dry run (show what would be done)
    sudo $SCRIPT_NAME --dry-run

EOF
}

fix_enterprise() {
  local -i dry_run=$1
  local -i count=0

  [[ -d $ENTERPRISE_DIR ]] || die 1 "Enterprise directory not found: $ENTERPRISE_DIR"

  echo "=== Fixing Enterprise Permissions ==="
  echo "Directory: $ENTERPRISE_DIR"
  ((dry_run)) && echo 'MODE: DRY RUN (no changes)'
  echo

  # Fix ownership
  info "Setting ownership: root:$CLAUDE_GROUP"
  if ((dry_run)); then
    echo "  [dry-run] chown -R root:$CLAUDE_GROUP $ENTERPRISE_DIR"
  else
    chown -R root:"$CLAUDE_GROUP" "$ENTERPRISE_DIR"
  fi

  # Fix directory permissions (setgid)
  info 'Setting directory permissions (2775)...'
  while IFS= read -r -d '' dir; do
    count+=1
    if ((dry_run)); then
      echo "  [dry-run] chmod 2775 $dir"
    else
      chmod 2775 "$dir"
    fi
  done < <(find "$ENTERPRISE_DIR" -type d -print0)
  status "Processed $count directories"

  # Fix file permissions
  count=0
  info 'Setting file permissions (664)...'
  while IFS= read -r -d '' file; do
    count+=1
    if ((dry_run)); then
      echo "  [dry-run] chmod 664 $file"
    else
      chmod 664 "$file"
    fi
  done < <(find "$ENTERPRISE_DIR" -type f -print0)
  status "Processed $count files"

  # Fix shell script permissions (hook handlers need execute)
  local -i sh_count=0
  local -- plugins_dir="$ENTERPRISE_DIR"/.claude/plugins
  if [[ -d $plugins_dir ]]; then
    info 'Making shell scripts executable (775)...'
    while IFS= read -r -d '' script; do
      sh_count+=1
      if ((dry_run)); then
        echo "  [dry-run] chmod 775 $script"
      else
        chmod 775 "$script"
      fi
    done < <(find "$plugins_dir" -name "*.sh" -type f -print0 2>/dev/null)
    if ((sh_count)); then
      status "Made $sh_count scripts executable"
    else
      status "No shell scripts found"
    fi
  fi

  echo
  if ((dry_run)); then
    echo '=== Dry Run Complete (no changes made) ==='
  else
    echo '=== Enterprise Permissions Fixed ==='
    stat -c "  %A %U:%G %n" "$ENTERPRISE_DIR" "$ENTERPRISE_DIR/.claude" 2>/dev/null || true
  fi
}

fix_user() {
  local -- username=$1
  local -i dry_run=$2
  local -i count=0

  # Get home directory
  local -- user_home
  user_home=$(getent passwd "$username" | cut -d: -f6)
  [[ -n $user_home ]] || die 1 "Could not determine home directory for ${username@Q}"

  local -- target="$user_home/.claude"
  [[ -d $target ]] || die 1 "User .claude directory not found: $target"

  echo "=== Fixing User Permissions ==="
  echo "User: $username"
  echo "Directory: $target"
  ((dry_run)) && echo 'MODE: DRY RUN (no changes)'
  echo

  # Fix ownership
  info "Setting ownership: $username:$username"
  if ((dry_run)); then
    echo "  [dry-run] chown -R $username:$username $target"
  else
    chown -R "$username":"$username" "$target"
  fi

  # Fix directory permissions
  info 'Setting directory permissions (755)...'
  while IFS= read -r -d '' dir; do
    count+=1
    if ((dry_run)); then
      echo "  [dry-run] chmod 755 $dir"
    else
      chmod 755 "$dir"
    fi
  done < <(find "$target" -type d -print0)
  status "Processed $count directories"

  # Fix file permissions
  count=0
  info 'Setting file permissions (644)...'
  while IFS= read -r -d '' file; do
    count+=1
    if ((dry_run)); then
      echo "  [dry-run] chmod 644 $file"
    else
      chmod 644 "$file"
    fi
  done < <(find "$target" -type f -print0)
  status "Processed $count files"

  # Protect credentials
  local -- creds_file="$target"/.credentials.json
  if [[ -f $creds_file ]]; then
    info 'Protecting credentials file (600)...'
    if ((dry_run)); then
      echo "  [dry-run] chmod 600 $creds_file"
    else
      chmod 600 "$creds_file"
    fi
    status 'Credentials protected'
  fi

  echo
  if ((dry_run)); then
    echo '=== Dry Run Complete (no changes made) ==='
  else
    echo '=== User Permissions Fixed ==='
    stat -c "  %A %U:%G %n" "$target" 2>/dev/null || true
  fi
}

main() {
  local -i dry_run=0
  local -- target_user=''

  # Parse arguments
  while (($#)); do
    case $1 in
      -h|--help)    show_help; return 0 ;;
      -V|--version) echo "$SCRIPT_NAME $VERSION"; return 0 ;;
      -n|--dry-run) dry_run=1 ;;
      -u|--user)    (($#>1)) || die 22 "Option ${1@Q} requires a username"
                    shift
                    target_user=$1
                    ;;
      -*)           die 22 "Invalid option ${1@Q} (use --help)" ;;
      *)            die 2  "Unexpected argument ${1@Q}" ;;
    esac
    shift
  done

  # Check root
  ((EUID == 0)) || die 1 'This script must be run as root (use sudo)'

  if [[ -n $target_user ]]; then
    # Fix user permissions
    fix_user "$target_user" "$dry_run"
  else
    # Fix enterprise permissions
    fix_enterprise "$dry_run"
  fi
}

main "$@"

#fin
